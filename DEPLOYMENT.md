# Railway Deployment Guide

## Prerequisites
- Railway account (sign up at https://railway.app)
- GitHub repository connected to Railway

## Step 1: Create New Project on Railway

1. Go to Railway dashboard
2. Click "New Project"
3. Select "Deploy from GitHub repo"
4. Choose this repository

## Step 2: Add PostgreSQL Database

1. In your Railway project, click "New"
2. Select "Database" → "PostgreSQL"
3. Railway will automatically create a PostgreSQL instance
4. Copy the `DATABASE_URL` connection string

## Step 3: Configure Environment Variables

Go to your service settings → Variables, and add the following:

### Required Variables:

```bash
# Node Environment
NODE_ENV=production
PORT=${{PORT}}  # Railway auto-provides this

# Database (Auto-generated by Railway PostgreSQL)
DATABASE_URL=${{PGDATABASE.DATABASE_URL}}  # Use Railway's reference variable

# JWT Secrets (Generate strong secrets!)
ACCESS_TOKEN_SECRET=your-strong-random-secret-here-min-64-chars
REFRESH_TOKEN_SECRET=your-different-strong-secret-here-min-64-chars

# Session Secret
SECRET_KEY=your-session-secret-key-min-32-chars

# CORS Settings (Your frontend URL)
WEB_URL=https://your-frontend-domain.com,https://www.your-frontend-domain.com

# File Upload
MAX_FILE_SIZE=5242880
UPLOAD_DIR=./uploads

# Pagination
DEFAULT_PAGE_SIZE=10
MAX_PAGE_SIZE=100
```

### How to Generate Secure Secrets:

```bash
# On Mac/Linux terminal:
openssl rand -base64 64

# Or use Node.js:
node -e "console.log(require('crypto').randomBytes(64).toString('base64'))"
```

## Step 4: Configure Build & Deploy

Railway will automatically detect your `railway.json` configuration:

```json
{
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "npm install && npm run build"
  },
  "deploy": {
    "startCommand": "npm run deploy"
  }
}
```

## Step 5: Deploy

1. Push your code to GitHub
2. Railway will automatically:
   - Install dependencies
   - Generate Prisma Client
   - Build TypeScript
   - Run migrations (`prisma migrate deploy`)
   - Start the server

## Step 6: Run Initial Seed (Optional)

After first deployment, you can run seed manually:

1. Go to your service → "Settings" → "Deployments"
2. Click on the latest deployment
3. Open terminal and run:
   ```bash
   npm run seed
   ```

## Step 7: Verify Deployment

1. Check the deployment logs for any errors
2. Visit your Railway-provided URL (e.g., `https://your-app.up.railway.app`)
3. Test the API:
   ```bash
   curl https://your-app.up.railway.app/api/v1
   ```

## Custom Domain (Optional)

1. Go to service "Settings" → "Domains"
2. Click "Add Domain"
3. Add your custom domain
4. Update DNS records as instructed
5. Update `WEB_URL` environment variable

## Monitoring & Logs

- **View Logs**: Click on your service → "View Logs"
- **Metrics**: Railway provides CPU, Memory, and Network metrics
- **Alerts**: Set up alerts for downtime or errors

## Database Backups

Railway automatically backs up your PostgreSQL database. To manually backup:

1. Go to PostgreSQL service
2. Click "Backups"
3. Create manual backup if needed

## Rolling Back Deployments

If something goes wrong:

1. Go to "Deployments" tab
2. Find a previous working deployment
3. Click "Redeploy"

## Environment-Specific Tips

### Production Best Practices:

1. **Enable Logs**: Monitor Railway logs regularly
2. **Set Alerts**: Configure alerts for downtime
3. **Database Backups**: Schedule regular backups
4. **Health Checks**: Implement `/health` endpoint
5. **Rate Limiting**: Add rate limiting middleware
6. **Secrets Rotation**: Rotate JWT secrets periodically

### Cost Optimization:

1. **Resource Limits**: Set appropriate memory limits
2. **Auto-scaling**: Enable if traffic is variable
3. **Database Connection Pooling**: Prisma handles this automatically
4. **Monitor Usage**: Track Railway usage dashboard

## Troubleshooting

### Build Fails:
- Check if all dependencies are in `package.json`
- Verify `NODE_VERSION` is compatible (16+)
- Check build logs for specific errors

### Migration Fails:
- Ensure `DATABASE_URL` is correctly set
- Check if migration files are committed to git
- Try running migrations manually in Railway terminal

### App Crashes on Start:
- Check environment variables are set
- Verify `PORT` variable is using Railway's `${{PORT}}`
- Review startup logs for errors

### Database Connection Issues:
- Verify `DATABASE_URL` format
- Check if PostgreSQL service is running
- Ensure Prisma Client is generated

## Update Process

To deploy updates:

1. Make changes locally
2. Test thoroughly
3. Commit and push to GitHub
4. Railway auto-deploys
5. Monitor logs for issues
6. Run new migrations if schema changed

## Support

- Railway Docs: https://docs.railway.app
- Railway Discord: https://discord.gg/railway
- Project GitHub Issues: [Your repo]/issues

---

**Last Updated:** December 12, 2025
